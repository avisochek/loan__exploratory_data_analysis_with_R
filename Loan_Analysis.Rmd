Loan Data Exploration by Allan Visochek
## Investigate The following variables
 Borrower Attributes: 
>CreditGrade
>CreditScoreRangeLower
>EmploymentStatus
>IsBorrowerHomeOwner
>LoanMonthsSinceOrigination
>StatedMonthlyIncome
>IncomeRange
>BorrowerState
>Occupation
>DebtToIncomeRatio
Loan Attributes:
>Term
>BorrowerRate
>LoanOriginalAmount
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using
# in your analysis in this code chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk.
# This prevents the code from displaying in the knitted HTML output.
# You should set echo=FALSE for all code chunks in your file.

library(ggplot2)
library(scales)
library(gridExtra)
```

#```{r echo=FALSE, Load_the_Data}
# Load the Data
setwd('Documents/data_science/p3/final_project/')
loanData<-read.csv('../data/prosperLoanData.csv')
loanData$Term <-factor(loanData$Term)
loanData$HasCreditGrade <- !(loanData$CreditGrade=='')
loanData$DebtLevel <- cut(loanData$DebtToIncomeRatio,c(0,.3,.49,1,10.5))
loanData$LoanPeriod <- cut(loanData$LoanMonthsSinceOrigination,c(0,13,56,65,105))
loanData$LoanPeriod2 <-cut(loanData$LoanMonthsSinceOrigination,c(0,55,105),labels=c("post-recession","pre-recession"))
loanData
loanData$BadCredit <-loanData$CreditScoreRangeLower<600
loanData$DebtLevelBucket <- cut(loanData$DebtToIncomeRatio,c(0,0.49,1,10))

loanData$LoanOriginalAmountBucket <- cut(loanData$LoanOriginalAmount,seq(0,25000,1000))
#```



# Univariate Plots Section
```{r echo=FALSE, Univariate_Plots}
### Loan Info----
ggplot(aes(x=BorrowerRate),data=loanData)+
  geom_histogram(binwidth=.005)+
  scale_x_continuous(breaks=seq(0,.5,.02))

summary(loanData$BorrowerRate)
## BorrowerRate Ranges from 0 to .05
quantile(loanData$BorrowerRate,.1)
quantile(loanData$BorrowerRate,.9)
## most borrowers have a rate between .1 and .31
loanData$BorrowerRateCategory<-cut(loanData$BorrowerRate,c(0,0.1,0.31,0.5),labels=c('low','normal','high'))


ggplot(aes(x=LoanOriginalAmount),data=loanData)+
  geom_histogram(binwidth = 5000)
summary(loanData$LoanOriginalAmount)
## all loans are between 0 and 35,000...
## 75% of loans are under 12,000...

ggplot(aes(x=Term),data=loanData)+
  geom_histogram()
## All loans have a term of either 1,3 or 5 years.
loanData$Term <-factor(loanData$Term)
### Borrower Info----

summary(loanData$EmploymentStatus)
## the large majority of loans go to individuals who are employed full time...

summary(loanData$IsBorrowerHomeowner)
## about half and half
summary(loanData$BorrowerState)
#pretty even distribution by population
summary(loanData$Occupation)


###Credit and Ratings-----
summary(loanData$ProsperRating..Alpha.)
summary(loanData$CreditGrade)
## A large number of Borrowers either don't have a prosper rating or a credit score...
## lets create new variables to indicate weather a user has a credit grade or a prosper rating
loanData$HasCreditGrade <- !(loanData$CreditGrade==''|is.na(loanData$CreditGrade))
loanData$HasProsperRating <- !(loanData$ProsperRating..Alpha.==''|is.na(loanData$ProsperRating..Alpha.))

## I'm also going to switch the order so that AA comes before A
loanData$ProsperRating..Alpha. <- factor(loanData$ProsperRating..Alpha., levels =c("AA","A","B","C","D","E","HR","NC",""))
loanData$ProsperRating..Alpha. <- factor(loanData$ProsperRating..Alpha., levels =c("AA","A","B","C","D","E","HR",""))
                               
ggplot(aes(x=CreditScoreRangeLower),data=loanData)+
  geom_histogram(binwidth=10)+
  scale_x_continuous(breaks=seq(0,900,20))+
  theme(axis.text.x=element_text(angle = 60, hjust = 1))
summary(loanData$CreditScoreRangeLower)
## Most borrowers have a credit score between 600 and 800


###Income----
summary(loanData$IncomeRange)
## few loans are given out to individuals with low income, or who are unemployed, no surprises here...
## let's reorder IncomeRange and create a new variable to indicate weather a borrower is reported as having an income 

loanData$IncomeRange <- factor(loanData$IncomeRange,levels=c("$75,000-99,999","$50,000-74,999","$25,000-49,999","$1-24,999","$0","Not employed","Not displayed"))

HasIncome <-loanData$IncomeRange == "$75,000-99,999"|loanData$IncomeRange == "$50,000-74,999"|loanData$IncomeRange == "$25,000-49,999"|loanData$IncomeRange == "$1-24,999"

ggplot(aes(StatedMonthlyIncome),data=loanData)+
  geom_histogram(binwidth=1000)

ggplot(aes(StatedMonthlyIncome),data=subset(loanData,StatedMonthlyIncome>0))+
  geom_histogram(binwidth=.05)+
  scale_x_log10()

ggplot(aes(StatedMonthlyIncome),data=subset(loanData,StatedMonthlyIncome>0))+
  geom_histogram(binwidth=.05)+
  scale_x_log10(limits=c(500,50000),breaks=c(1000,3000,10000,30000))
summary(loanData$StatedMonthlyIncome)

###Debt----
ggplot(aes(x=DebtToIncomeRatio),data=loanData)+
  geom_histogram(binwidth=.05)

ggplot(aes(x=DebtToIncomeRatio),data=loanData)+
  scale_x_log10(breaks=c(.01,.03,.1,.3,1))+
  geom_histogram(binwidth=.1)

ggplot(aes(x=DebtToIncomeRatio),data=loanData)+
  scale_x_log10(breaks=c(.01,.03,.1,.3,.49,1,10))+
  geom_histogram(binwidth=.1)

## I read that the general cutoff for getting a loan is .49... It seems odd to say the least that there are DebtToIncomeRatios in this dataset that are up to 1 and even greater than 10.
summary(loanData$DebtToIncomeRatio)
loanData$DebtLevel <- cut(loanData$DebtToIncomeRatio,c(0,.3,.49,1,10.5))
loanData$DebtLevel <- cut(loanData$DebtToIncomeRatio,c(0,.3,.49,1,10.5))
###Quarter-----

ggplot(aes(x=LoanOriginationQuarter),data=loanData)+
  geom_bar()+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
## Lets reorder these by time and try again

loanData$LoanOriginationQuarter <- factor(loanData$LoanOriginationQuarter, levels = c("Q1 2006","Q2 2006","Q3 2006" ,"Q4 2006","Q1 2007","Q2 2007","Q3 2007" ,"Q4 2007","Q1 2008","Q2 2008","Q3 2008" ,"Q4 2008","Q1 2009","Q2 2009","Q3 2009" ,"Q4 2009","Q1 2010","Q2 2010","Q3 2010" ,"Q4 2010","Q1 2011","Q2 2011","Q3 2011" ,"Q4 2011","Q1 2012","Q2 2012","Q3 2012" ,"Q1 2013","Q2 2013","Q3 2013" ,"Q4 2013","Q4 2013","Q1 2014"))

ggplot(aes(x=LoanOriginationQuarter),data=loanData)+
  geom_bar()+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
## thats better... we can see here that the number of loans given out dropped dramatically in the last quarter of 2008, ....
###----
```

# Univariate Analysis

### What is the structure of your dataset?
There are 113,937 loans in the dataset with 81 features, 13 of which were used in the analysis: 

####Numerical Variables:
BorrowerRate
CreditScoreRangeLower
DebtToIncomeRatio
LoanOriginalAmount
StatedMonthlyIncome 

####Ordered factor variables 
#####(from best to worst / greatest to least...)

#####Term: 
60,36,12
>(note that term was a numerical variable but was transformed to a factor variable because it has very few values)

#####CreditGrade: 
AA,A,B,C,D,E,HR,NC,none

#####ProsperRating..Alpha.: 
AA,A,B,C,D,E,HR,none

#####IncomeRange: 
$75,000-99,999 ; $50,000-74,999 ; $1-49,999 1-24,999 ; $0 ; Not employed; Not displayed


####Unordered factor variables:

#####EmploymentStatus:  
Employed, Full-time, Not employed, Part-time, Retired, Self-employed none,Not available, Other,

#####Occupation: 
Accountant/CPA, Administrative Assistant, Analyst, Architect, Attorney, Biologist, Bus Driver, Car Dealer, Chemist, Civil Service, Clergy, Computer Programmer, Construction, Dentist, Doctor, Engineer - Chemical, Engineer - Electrical, Engineer - Mechanical, Executive, Fireman, Flight Attendant, Food Service, Food Service Management, Homemaker, Investor, Judge, Laborer, Landscaping, Medical Technician, Military Enlisted, Military Officer, Nurse (LPN), Nurse (RN), Nurse's Aide, Other, Pharmacist, Pilot - Private/Commercial, Police Officer/Correction Officer, Postal Service, Principal, Professional, Professor, Psychologist, Realtor, Religious, Retail Management, Sales - Commission, Sales - Retail, Scientist, Skilled Labor, Social Worker, Student - College Freshman, Student - College Graduate Student, Student - College Junior, Student - College Senior, Student - College Sophomore, Student - Community College, Student - Technical School, Teacher, Teacher's Aide, Tradesman - Carpenter, Tradesman - Electrician, Tradesman - Mechanic, Tradesman - Plumber, Truck Driver, Waiter/Waitress

#####BorrowerState:
AK, AL, AR, AZ, CA, CO, CT, DC, DE, FL, GA, HI, IA, ID, IL, IN, KS, KY, LA, MA, MD, ME, MI, MN, MO, MS, MT, NC, ND, NE, NH, NJ, NM, NV, NY, OH, OK, OR, PA, RI, SC, SD, TN, TX, UT, VA, VT, WA, WI, WV, WY 


####Other observations:
The majority of loans go to individuals who are employed full time.
Few loans are given out to individuals with low income, or who are unemployed.
Most Borrowers do not have a credit grade.
Loans amounts range from 0 to $35,000. 
75% of loans are for under $12,000.
Nearly all of the loans given out are 100% funded.
Most loans have 0 net principal loss.
Most borrowers have 0 delinquincies in the past 7 years.
Few loans are given out from Q4 2008 through Q2 2009. 

### What is/are the main feature(s) of interest in your dataset?

The main features of interest are LoanOriginationQuarter and BorrowerRate.

### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?

It is hard to say at this point. All variables mentioned above were selected for the investigation because they are likely to have an impact on the borrower rate.

### Did you create any new variables from existing variables in the dataset?

loanData$BorrowerRateCategory<-cut(loanData$BorrowerRate,c(0,0.1,0.31,0.5),labels=c('low','normal','high'))

loanData$HasCreditGrade <- !(loanData$CreditGrade==''|is.na(loanData$CreditGrade))
loanData$HasProsperRating <- !(loanData$ProsperRating..Alpha.==''|is.na(loanData$ProsperRating..Alpha.))

HasIncome <-loanData$IncomeRange == "$75,000-99,999"|loanData$IncomeRange == "$50,000-74,999"|loanData$IncomeRange == "$25,000-49,999"|loanData$IncomeRange == "$1-24,999"

loanData$DebtLevel <- cut(loanData$DebtToIncomeRatio,c(0,.3,.49,1,10.5))


#####The following variables are created in later sections:

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?


debt to income....
stated monthly income...


I reordered the following factor variables:

ProsperScore..Alpha,
CreditGrade,
Incomerange,
LoanOrginationQuarter


# Bivariate Plots Section
```{r echo=FALSE, Bivariate_Plots}
###Distribution over time----
ggplot(aes(y=BorrowerRate,x=LoanOriginalAmount),data=loanData)+
  geom_point(alpha=1/5)

ggplot(aes(y=BorrowerRate,x=Term),data=loanData)+
  geom_boxplot()
with(loanData,by(BorrowerRate,Term,summary))

ggplot(aes(x=LoanOriginationQuarter,y=BorrowerRate,group=1),data=loanData)+
  geom_line(stat='summary',fun.y=mean)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
##Average Borrower Rate was decreasing significantly from 2012 to 2014

## Lets look at this in a bit more detail.
ggplot(aes(x=LoanOriginationQuarter,y=BorrowerRate,group=1),data=loanData)+
  geom_line(stat='summary',fun.y=quantile,probs =.1, linetype=2, color='blue')+
  geom_line(stat='summary',fun.y=quantile,probs =.5, linetype=2, color='blue')+
  geom_line(stat='summary',fun.y=quantile,probs =.9, linetype=2, color='blue')+
  geom_line(stat='summary',fun.y=mean)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))


ggplot(aes(x=BorrowerRate,color=LoanOriginationQuarter),data=subset(loanData,!is.na(LoanPeriod)))+
  geom_density()+
  scale_color_brewer(palette="Set1")
## This isn't quite working out... I'll have to look into the distribution over time more in the multivariate section...

ggplot(aes(y=BorrowerRate,x=LoanOriginationQuarter),data=subset(loanData,!is.na(LoanPeriod)))+
  geom_boxplot()+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
## All of the exceptionally high borrower rates(>0.4) occur in the first quarter of 2006

ggplot(aes(x=LoanOriginationQuarter,y=LoanOriginalAmount,group=1),data=loanData)+
  geom_line(stat="summary",fun.y=mean)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
#The average Loan amount went down steeply in Q4 2008 and has been rising steadily since then.

###Debt Level----

ggplot(aes(y=BorrowerRate,x=log10(DebtToIncomeRatio)),data=loanData)+
  geom_point(alpha=1/20)
## it doesn't look like there is a significant relationship from this graph...
ggplot(aes(y=BorrowerRate,x=log10(DebtToIncomeRatio)),data=loanData)+
  geom_line(stat='summary',fun.y=median)

ggplot(aes(y=BorrowerRate,x=DebtLevel),data=loanData)+
  geom_boxplot()
## It looks like there is a trend, although it is still not quite clear..
## I'm going to make a new variable, DebtLevelBucket to make a smoother plot..
loanData$DebtLevelBucket = cut(log10(loanData$DebtToIncomeRatio),seq(-3,1,.2))

ggplot(aes(y=BorrowerRate,x=DebtLevelBucket,group=1),data=loanData)+
  geom_line(stat='summary',fun.y=median)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))

ggplot(aes(y=BorrowerRate,x=DebtLevelBucket,group=1),data=loanData)+
  geom_line(stat='summary',fun.y=median)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))+
  facet_wrap(~LoanOriginationQuarter)
##  Borrower rate and debt level are correlated...

###Credit score and ratings----

ggplot(aes(y=BorrowerRate,x=CreditScoreRangeLower),data=loanData)+
  geom_point(alpha=1/20)

ggplot(aes(y=BorrowerRate,x=reorder(CreditGrade,BorrowerRate,FUN=median)),data=loanData)+
  geom_boxplot()
## Borrowers without a credit grade have borrower rate that is average relative to the others...

ggplot(aes(y=BorrowerRate,x=reorder(ProsperRating..Alpha.,BorrowerRate,FUN=median)),data=loanData)+
  geom_boxplot()
## Borrower rates are cleanly distributed among the different prosper ratings. (in contrast to the credit grades which overlap...)
## Borrowers without a prosper rating have a median borrower rate that is significantly lower than the others...
ggplot(aes(y=CreditScoreRangeLower,x=reorder(CreditGrade,BorrowerRate,FUN=median)),data=loanData)+
  geom_boxplot()

ggplot(aes(y=CreditScoreRangeLower,x=reorder(ProsperRating..Alpha.,BorrowerRate,FUN=median)),data=loanData)+
  geom_boxplot()
## Credit score varies much less among different prosper ratings than it does with credit grades...
## this is probably a different metric that the loan agency uses to distribute borrower rates...

###Income----
ggplot(aes(x=IncomeRange,y=StatedMonthlyIncome*12),data=loanData)+geom_boxplot()+coord_cartesian(ylim=c(0,150000))

ggplot(aes(y=BorrowerRate,x=reorder(IncomeRange,BorrowerRate,FUN=median)),data=subset(loanData,!is.na(LoanPeriod)))+
  geom_boxplot()
## The borrower rate goes down as income range goes up...

## DECIDE WEATHER TO INCLUDE THIS....
#####loanData$NoIncome <-with(loanData,IncomeRange=="$0" | IncomeRange=='Not displayed' | IncomeRange=='Not employed')

ggplot(aes(y=BorrowerRate,x=StatedMonthlyIncome),data=loanData)+
  geom_point()

ggplot(aes(y=BorrowerRate,x=StatedMonthlyIncome),data=loanData)+
  geom_point(alpha=1/10)+
  scale_x_log10(limits=c(500,50000))
## no apparent relationship between StatedMonthlyIncome and BorrowerRate...

loanData$StatedMonthlyIncomeBucket=cut(log10(loanData$StatedMonthlyIncome),seq(0,5,.2))

ggplot(aes(y=BorrowerRate,x=StatedMonthlyIncomeBucket,group=1),data=loanData)+
  geom_line(stat='summary',fun.y=median)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))

###EmploymentStatus and BorrowerRate----
ggplot(aes(y=BorrowerRate,x=reorder(EmploymentStatus,BorrowerRate,FUN=median)),data=loanData)+
  geom_boxplot()
##Unemployed borrowers have a significantly higher median that the rest of the categories...
ggplot(aes(y=BorrowerRate,x=IsBorrowerHomeowner),data=loanData)+
  geom_boxplot()

ggplot(aes(y=BorrowerRate,x=reorder(BorrowerState, BorrowerRate, FUN=median) ),data=loanData)+
  geom_boxplot()+
  coord_flip()

ggplot(aes(y=BorrowerRate,x=reorder(Occupation, BorrowerRate,FUN=median )),data=loanData)+
  geom_boxplot()+
  coord_flip()

####----
```

# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?
The average Borrower Rate was decreasing significantly from 2012 to 2014

The Lower 10% of borrower rates have remained relatively steady

The average Loan amount went down steeply in Q4 2008 and has been rising steadily since then.

## it doesn't look like there is a significant relationship from this graph...

## It looks like there is a trend, although it is still not quite clear..
## I'm going to make a new variable, DebtLevelBucket to make a smoother plot..
##  Borrower rate and debt level are correlated...

###Credit score and ratings----

## Borrowers without a credit grade have borrower rate that is average relative to the others...

## Borrower rates are cleanly distributed among the different prosper ratings. (in contrast to the credit grades which overlap...)
## Borrowers without a prosper rating have a median borrower rate that is significantly lower than the others...

## Credit score varies much less among different prosper ratings than it does with credit grades...
## this is probably a different metric that the loan agency uses to distribute borrower rates...



Borrower Rate varies significantly by CreditGrade. 


Borrower Rates seem to vary accross states quite a bit. The median borrower rate by state varies from approximately .15 to .2

Occupation has a strong influence on BorrowerRate. Occupations with a higher level of education (i.e. engineer, computer programmer, judge etc..) have borrower rates on the lower end of the spectrum while occupations with a lower level of education (i.e. college freshman, Nurse's Aide, Bus Driver, Laborer), have BorrowerRates on the higher end of the spectrum. Median Borrower rate by occupation varies from approximately .125 to .225
### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

### What was the strongest relationship you found?
The strongest Relationship was between the Borrower Rate and Credit Grade, although 

# Multivariate Plots Section

```{r echo=FALSE, Multivariate_Plots}
### Overview----
ggplot(aes(x=LoanOriginalAmount,y=BorrowerRate),data=loanData)+
  geom_point()+
  facet_wrap(~Term,ncol=1)

ggplot(aes(x=LoanOriginalAmount,y=BorrowerRate),data=loanData)+
  geom_point()+
  facet_wrap(~LoanPeriod,ncol=1)

p1<-ggplot(aes(x=LoanOriginationQuarter,group=1),data=loanData)+
  geom_histogram(binwidth=1)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
p2<-ggplot(aes(x=LoanOriginationQuarter,group=1,y=BorrowerRate),data=loanData)+
  geom_line(stat='summary',fun.y=median)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
p3<-ggplot(aes(x=LoanOriginationQuarter,group=1,y=LoanOriginalAmount),data=loanData)+
  geom_line(stat='summary',fun.y=median)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
grid.arrange(p1,p2,p3,ncol=1)

p1<-ggplot(aes(x=LoanOriginationQuarter,group=1),data=loanData)+
  geom_histogram(binwidth=1)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
p2<-ggplot(aes(x=LoanOriginationQuarter,group=1,y=1/BorrowerRate),data=loanData)+
  geom_line(stat='summary',fun.y=median)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
p3<-ggplot(aes(x=LoanOriginationQuarter,group=1,y=LoanOriginalAmount),data=loanData)+
  geom_line(stat='summary',fun.y=median)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
grid.arrange(p1,p2,p3,ncol=1)
# the average loan amount is closely correlated with the number of loans given out.

###CreditGrade&Ratings----

##Credit score by Quarter---
ggplot(aes(x=LoanOriginationQuarter,group=1,y=CreditScoreRangeLower),
       data=subset(loanData,!is.na(LoanOriginationQuarter)))+
  geom_line(stat='summary',fun.y=quantile,probs =.1, linetype=2, color='blue')+
  geom_line(stat='summary',fun.y=quantile,probs =.5, linetype=2, color='blue')+
  geom_line(stat='summary',fun.y=quantile,probs =.9, linetype=2, color='blue')+
  geom_line(stat='summary',fun.y=mean)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
# the lower end of the distribution of credit scores moved up significantly after the recession.
##CreditGrade/ProsperRating---
ggplot(aes(x=LoanOriginationQuarter,group=1,y=BorrowerRate),
       data=subset(loanData,!is.na(LoanOriginationQuarter)))+
  geom_line(aes(group=ProsperRating..Alpha., color=ProsperRating..Alpha.),
            stat="summary",fun.y=mean)

ggplot(aes(x=LoanOriginationQuarter,group=1,y=BorrowerRate,),
       data=subset(loanData,!is.na(LoanOriginationQuarter)))+
  geom_line(aes(group=CreditGrade,color=CreditGrade),
            stat="summary",fun.y=mean)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))

# ok, now I get it... The company used credit grade to determine the 
# borrower rate up until the recession and then started using their 
# own metric namely, the Prosper Rating
# lets make a new variable to separate the the pre-recession loans from the post recession loans....

loanData$LoanPeriod2 <-cut(loanData$LoanMonthsSinceOrigination,c(0,55,105),labels=c("post-recession","pre-recession"))
## scatter of rate by quarter---
p1<-ggplot(aes(y=BorrowerRate,x=LoanOriginationQuarter,group=1),data=loanData)+
  geom_point(aes(group=CreditGrade,color=CreditGrade))+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))

p2<-ggplot(aes(y=BorrowerRate,x=LoanOriginationQuarter,group=1),data=loanData)+
  geom_point(aes(group=ProsperRating..Alpha.,color=ProsperRating..Alpha.))+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
grid.arrange(p1,p2,ncol=1)
##distribution of credit grade and borrower rate over time---
ggplot(aes(x=BorrowerRate),
       data=subset(loanData,LoanPeriod2=="pre-recession"))+
  geom_density(aes(color=CreditGrade))+
  facet_wrap(~LoanOriginationQuarter)

ggplot(aes(x=BorrowerRate),
       data=subset(loanData,LoanPeriod2=="post-recession"))+
  geom_density(aes(color=ProsperRating..Alpha.))
  facet_wrap(~LoanOriginationQuarter)

ggplot(aes(x=BorrowerRate),
       data=subset(loanData,LoanPeriod2=="post-recession"))+
  geom_density(aes(color=ProsperRating..Alpha.))+
  coord_cartesian(ylim=c(0,1000))+
  facet_wrap(~LoanOriginationQuarter)

ggplot(aes(x=BorrowerRate),
       data=subset(loanData,LoanPeriod2=="post-recession"))+
  geom_density(aes(color=ProsperRating..Alpha.))+
  coord_cartesian(ylim=c(0,250))+
  facet_wrap(~LoanOriginationQuarter)

ggplot(aes(x=BorrowerRate),
       data=subset(loanData,LoanPeriod2=="post-recession"))+
  geom_density(aes(color=ProsperRating..Alpha.))+
  coord_cartesian(ylim=c(0,100))+
  facet_wrap(~LoanOriginationQuarter)
##credit score vs. borrower rate by quarter---

ggplot(aes(y=BorrowerRate,x=CreditScoreRangeLower),data=subset(loanData,!is.na(LoanPeriod2)))+
  geom_point(alpha=1/5)+
  facet_wrap(~LoanPeriod2)

ggplot(aes(y=BorrowerRate,x=CreditScoreRangeLower),data=subset(loanData,!is.na(LoanPeriod2)))+
  geom_point()+
  facet_wrap(~LoanOriginationQuarter,ncol=4)+
  scale_x_continuous(breaks=seq(0,900,20))
ggplot(aes(y=BorrowerRate,x=CreditScoreRangeLower),data=subset(loanData,!is.na(LoanPeriod2)))+
  geom_point()+
  facet_wrap(~LoanOriginationQuarter,ncol=4)+
  geom_line(stat="summary",fun.y=median,color='red')+
  scale_x_continuous(breaks=seq(0,900,50))+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
## post recession, there is a strict cutoff at a credit score of 600
## I will define bad credit as having a credit score of less than 600.. 
loanData$BadCredit <-loanData$CreditScoreRangeLower<600
## credit score is correlated to Borrower Rate, although that correlation changes by quarter.
## pre-recession the distribution of borrower rates is more closely correlated to credit score and is quite even for borrowers under 600
###Term,LoanOriginalAmount and Quarter----
p1<-ggplot(aes(x=LoanOriginalAmount,y=BorrowerRate),data=subset(loanData,LoanPeriod2=="pre-recession"))+
  geom_point()+
  facet_wrap(~Term,ncol=1)

p2<-ggplot(aes(x=LoanOriginalAmount,y=BorrowerRate),data=subset(loanData,LoanPeriod2=="post-recession"))+
  geom_point()+
  facet_wrap(~Term,ncol=1)

grid.arrange(p1,p2,ncol=1)

# All pre-recession loans have a term of 36 months... Lets start there...
# I'm making a new variable, LoanOriginalAmountBucket 
# in order to get a better sense of the trends related to loan amount 
loanData$LoanOriginalAmountBucket <- cut(loanData$LoanOriginalAmount,seq(0,25000,1000))
##Pre-recession---
ggplot(aes(x=LoanOriginalAmount,group=1,y=BorrowerRate),
       data=subset(loanData,LoanPeriod2=="pre-recession"))+
  geom_point()+
  facet_wrap(~CreditGrade)+
  geom_line(stat='summary',fun.y=median,color='red')

ggplot(aes(x=LoanOriginalAmountBucket,group=1,y=BorrowerRate,group=1),
       data=subset(loanData,LoanPeriod2=="pre-recession"))+
  geom_point()+
  facet_wrap(~CreditGrade)+
  geom_line(stat='summary',fun.y=median,color='red')
# so there is a clean relationship between the borrower rate and the loan amount that seems to break down for credit grades lower than C

ggplot(aes(x=LoanOriginalAmount,group=1,y=BorrowerRate),
       data=subset(loanData,LoanPeriod2=="pre-recession"))+
  geom_point(aes(color=CreditGrade))

ggplot(aes(x=LoanOriginalAmountBucket,group=1,y=BorrowerRate),
       data=subset(loanData,LoanPeriod2=="pre-recession"))+
  geom_point(aes(color=CreditGrade),alpha=1/3)+
  facet_wrap(~LoanOriginationQuarter)

ggplot(aes(x=LoanOriginalAmountBucket,group=1,y=BorrowerRate),
       data=subset(loanData,LoanPeriod2=="pre-recession"))+
  geom_point(alpha=1/3)+
  facet_wrap(~LoanOriginationQuarter)+
  geom_line(stat='summary',fun.y=median,color='red')

ggplot(aes(x=LoanOriginalAmountBucket,group=1,y=BorrowerRate),
       data=subset(loanData,LoanPeriod2=="pre-recession"))+
  facet_wrap(~LoanOriginationQuarter)+
  geom_line(aes(group=CreditGrade,color=CreditGrade),stat='summary',fun.y=median)

with(subset(loanData,LoanPeriod2=="pre-recession"),cor.test(BorrowerRate,LoanOriginalAmount))


## Post Recession
ggplot(aes(x=LoanOriginalAmount,y=BorrowerRate),data=subset(loanData,LoanPeriod2=="post-recession"))+
  geom_point(aes(color=ProsperRating..Alpha.))+
  facet_wrap(~Term,ncol=1)

ggplot(aes(x=LoanOriginalAmount,y=BorrowerRate),
       data=subset(loanData,LoanPeriod2=="post-recession"&Term=='36'))+
  geom_point()+
  facet_wrap(~ProsperRating..Alpha.)

ggplot(aes(x=LoanOriginalAmount,y=BorrowerRate),
       data=subset(loanData,LoanPeriod2=="post-recession"&Term=='36'))+
  geom_point(aes(color=ProsperRating..Alpha.))+
  facet_wrap(~LoanOriginationQuarter)
# The loan original amount seems to have been used to determine borrower rate up until Q3 2010

#### NEED TO VERIFY THIS....
####
####

ggplot(aes(x=LoanOriginalAmount,y=BorrowerRate),
       data=subset(loanData,LoanPeriod2=="post-recession"&Term=='12'))+
  geom_point(aes(color=ProsperRating..Alpha.))+
  facet_wrap(~LoanOriginationQuarter)
# 1 year loans were only offered as of Q4 2010, 
# so the loan original amount does not effect 
# the borrower rate for any such loans

ggplot(aes(x=LoanOriginalAmount,y=BorrowerRate),
       data=subset(loanData,LoanPeriod2=="post-recession"&Term=='60'))+
  geom_point(aes(color=ProsperRating..Alpha.))+
  facet_wrap(~LoanOriginationQuarter)
# the same goes for the 5 year loans...
###Income Level ----
ggplot(aes(x=LoanOriginationQuarter,group=1,y=BorrowerRate),
       data=subset(loanData,!is.na(LoanOriginationQuarter)&!is.na(IncomeRange)))+
  geom_line(aes(group=IncomeRange,color=IncomeRange),stat="summary",fun.y=mean)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))

ggplot(aes(x=LoanOriginationQuarter,group=1,y=BorrowerRate),
       data=subset(loanData,!is.na(LoanOriginationQuarter)&!is.na(IncomeRange)&!(IncomeRange=="$0")))+
  geom_line(aes(group=IncomeRange,color=IncomeRange),stat="summary",fun.y=mean)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))

## aside from a few isolated cases, the median borrower rate is divided by income range....
## the question now is weather this trend can be distinguished from credit score...
ggplot(aes(y=BorrowerRate,x=factor(CreditScoreRangeLower)),data=loanData)+
  geom_boxplot(aes(color=IncomeRange))

## it is not quite clear from this graph.. lets try something else
ggplot(aes(y=BorrowerRate,x=CreditScoreRangeLower),data=loanData)+
  geom_line(aes(color=IncomeRange),stat="summary",fun.y=median)

ggplot(aes(y=BorrowerRate,x=CreditScoreRangeLower),
       data=subset(loanData,!is.na(IncomeRange)))+
  geom_line(aes(color=IncomeRange),stat="summary",fun.y=median)

ggplot(aes(y=BorrowerRate,x=CreditScoreRangeLower),
       data=subset(loanData,
                   !is.na(IncomeRange)
                   &!(IncomeRange=="Not employed")
                   &!(IncomeRange=="$0")))+
  geom_line(aes(color=IncomeRange),stat="summary",fun.y=median)

ggplot(aes(y=BorrowerRate,x=CreditScoreRangeLower),
       data=subset(loanData,
                   !is.na(IncomeRange)
                   &!(IncomeRange=="Not employed")
                   &!(IncomeRange=="$0")
                   &!(IncomeRange=="Not displayed")))+
  geom_line(aes(color=IncomeRange),stat="summary",fun.y=median)+
  facet_wrap(~LoanOriginationQuarter)

## It is still not clear from this graph, however it looks like Borrower rates are slightly divided by Income Range as of Q4 2010. Recall that that is when LoanOrginalAmount was no longer used to determine the Borrower Rate and when 1 and 5 year loans started.

ggplot(aes(y=BorrowerRate*LoanOriginalAmount,x=CreditScoreRangeLower),
       data=subset(loanData,
                   !is.na(IncomeRange)
                   &!(IncomeRange=="Not employed")
                   &!(IncomeRange=="$0")
                   &!(IncomeRange=="Not displayed")
                   &(LoanOriginationQuarter =="Q3 2010"|LoanOriginationQuarter =="Q2 2010"|LoanOriginationQuarter =="Q1 2010"|LoanOriginationQuarter =="Q4 2009"|LoanOriginationQuarter =="Q3 2009"|LoanOriginationQuarter =="Q2 2009"|LoanOriginationQuarter =="Q1 2009"|LoanOriginationQuarter =="Q4 2008"|LoanOriginationQuarter =="Q3 2008"|LoanOriginationQuarter =="Q2 2008"|LoanOriginationQuarter =="Q1 2008"|LoanOriginationQuarter =="Q4 2007"|LoanOriginationQuarter =="Q3 2007"|LoanOriginationQuarter =="Q2 2007"|LoanOriginationQuarter =="Q1 2007")))+
  geom_line(aes(color=IncomeRange),stat="summary",fun.y=median)+
  facet_wrap(~LoanOriginationQuarter)

## When Loan Original Amount is taken into account, there appears to be a trend towards higher borrower rate for borrowers with lower income... for Those loans before Q4 2010

ggplot(aes(y=BorrowerRate,x=CreditScoreRangeLower),
       data=subset(loanData,
                   !is.na(IncomeRange)
                   &!(IncomeRange=="Not employed")
                   &!(IncomeRange=="$0")
                   &!(IncomeRange=="Not displayed")
                   &(Term=="36")
                   &((LoanOriginationQuarter =="Q1 2014"|LoanOriginationQuarter =="Q4 2013"|LoanOriginationQuarter =="Q3 2013"|LoanOriginationQuarter =="Q2 2013"|LoanOriginationQuarter =="Q1 2013"|LoanOriginationQuarter =="Q4 2012"|LoanOriginationQuarter =="Q3 2012"|LoanOriginationQuarter =="Q2 2012"||LoanOriginationQuarter =="Q1 2012"|LoanOriginationQuarter =="Q4 2011"|LoanOriginationQuarter =="Q3 2011"|LoanOriginationQuarter =="Q2 2011"|LoanOriginationQuarter =="Q1 2011"|LoanOriginationQuarter =="Q4 2010"))))+
  geom_line(aes(color=IncomeRange),stat="summary",fun.y=median)+
  facet_wrap(~LoanOriginationQuarter)
## this is a bit better

ggplot(aes(y=BorrowerRate,x=CreditScoreRangeLower),
       data=subset(loanData,
                   !is.na(IncomeRange)
                   &!(IncomeRange=="Not employed")
                   &!(IncomeRange=="$0")
                   &!(IncomeRange=="Not displayed")
                   &(Term=="60")
                   &(LoanOriginationQuarter =="Q1 2014"|LoanOriginationQuarter =="Q4 2013"|LoanOriginationQuarter =="Q3 2013"|LoanOriginationQuarter =="Q2 2013"|LoanOriginationQuarter =="Q1 2013"|LoanOriginationQuarter =="Q4 2012"|LoanOriginationQuarter =="Q3 2012"|LoanOriginationQuarter =="Q2 2012"||LoanOriginationQuarter =="Q1 2012"|LoanOriginationQuarter =="Q4 2011"|LoanOriginationQuarter =="Q3 2011"|LoanOriginationQuarter =="Q2 2011"|LoanOriginationQuarter =="Q1 2011"|LoanOriginationQuarter =="Q4 2010")))+
  geom_line(aes(color=IncomeRange),stat="summary",fun.y=median)+
  facet_wrap(~LoanOriginationQuarter)
## This is unclear, due to the small number of 5 year loans.

ggplot(aes(y=BorrowerRate,x=CreditScoreRangeLower),
       data=subset(loanData,
                   !is.na(IncomeRange)
                   &!(IncomeRange=="Not employed")
                   &!(IncomeRange=="$0")
                   &!(IncomeRange=="Not displayed")
                   &(Term=="12")
                   &(LoanOriginationQuarter =="Q1 2014"|LoanOriginationQuarter =="Q4 2013"|LoanOriginationQuarter =="Q3 2013"|LoanOriginationQuarter =="Q2 2013"|LoanOriginationQuarter =="Q1 2013"|LoanOriginationQuarter =="Q4 2012"|LoanOriginationQuarter =="Q3 2012"|LoanOriginationQuarter =="Q2 2012"||LoanOriginationQuarter =="Q1 2012"|LoanOriginationQuarter =="Q4 2011"|LoanOriginationQuarter =="Q3 2011"|LoanOriginationQuarter =="Q2 2011"|LoanOriginationQuarter =="Q1 2011"|LoanOriginationQuarter =="Q4 2010")))+
  geom_line(aes(color=IncomeRange),stat="summary",fun.y=median)+
  facet_wrap(~LoanOriginationQuarter)
#This is unclear due to the small number 1 year loans
# I will leave 1 and 5 year loans out of the analysis from now on...


# lets try again for a continuous scatter plot
# before Q4 2010, limited to those borrowers with Income
ggplot(aes(y=BorrowerRate,x=StatedMonthlyIncome),
       data=subset(loanData,
                   !(is.na(IncomeRange)|IncomeRange=="Not employed"|IncomeRange=="$0"|IncomeRange=="Not displayed")
                   &(LoanOriginationQuarter =="Q3 2010"|LoanOriginationQuarter =="Q2 2010"|LoanOriginationQuarter =="Q1 2010"|LoanOriginationQuarter =="Q4 2009"|LoanOriginationQuarter =="Q3 2009"|LoanOriginationQuarter =="Q2 2009"|LoanOriginationQuarter =="Q1 2009"|LoanOriginationQuarter =="Q4 2008"|LoanOriginationQuarter =="Q3 2008"|LoanOriginationQuarter =="Q2 2008"|LoanOriginationQuarter =="Q1 2008"|LoanOriginationQuarter =="Q4 2007"|LoanOriginationQuarter =="Q3 2007"|LoanOriginationQuarter =="Q2 2007"|LoanOriginationQuarter =="Q1 2007")))+
  geom_point(alpha=1/5)+
  facet_wrap(~LoanOriginationQuarter)
###Debt----
ggplot(aes(x=LoanOriginationQuarter,group=1,y=BorrowerRate),data=loanData)+
  geom_line(aes(group=DebtLevelBucket,color=DebtLevelBucket),stat="summary",fun.y=median)

ggplot(aes(y=BorrowerRate,x=CreditGrade),data=loanData)+
  geom_boxplot(aes(color=DebtLevelBucket))+
  facet_wrap(~LoanOriginationQuarter)

ggplot(aes(x=DebtToIncomeRatio,y=BorrowerRate),data=loanData)+
  geom_point(alpha=1/20)+
  facet_wrap(~LoanOriginationQuarter)+
  scale_x_log10()

ggplot(aes(x=DebtToIncomeRatio,y=BorrowerRate),data=loanData)+
  geom_point(alpha=1/20)+
  facet_wrap(~LoanOriginationQuarter)+
  scale_x_log10(limits=c(0.01,1),breaks = c(0.01,0.03,0.1,0.3,0.49,1))
# it is clear that debt to income ratio has a major effect on the lower limit of the borrower rate
# it is not that clear though weather it plays a direct role in determining the borrower rate.
ggplot(aes(x=DebtToIncomeRatio,y=BorrowerRate),data=loanData)+
  geom_point(alpha=1/10)+
  facet_wrap(~LoanOriginationQuarter)+
  scale_x_continuous(limits=c(0.01,1),breaks = seq(0,1,.2))

# lets try making a new parameter, available monthly income and see what that does...
loanData$AvailableMonthlyIncome = loanData$StatedMonthlyIncome*(1-loanData$DebtToIncomeRatio)

ggplot(aes(y=BorrowerRate,x=AvailableMonthlyIncome),
       data=loanData)+
  geom_point()+
  facet_wrap(~LoanOriginationQuarter)+
  scale_x_continuous(limits=c(500,5000))

ggplot(aes(y=BorrowerRate,x=AvailableMonthlyIncome),
       data=loanData)+
  geom_point(alpha=1/20)+
  facet_wrap(~LoanOriginationQuarter)+
  scale_x_continuous(limits=c(500,5000))

ggplot(aes(y=BorrowerRate,x=AvailableMonthlyIncome),
       data=loanData)+
  geom_point(alpha=1/20)+
  facet_wrap(~LoanOriginationQuarter)+
  scale_x_log10(limits=c(500,10000))

ggplot(aes(y=BorrowerRate,x=AvailableMonthlyIncome),
       data=subset(loanData,
                   !is.na(IncomeRange)
                   &!(IncomeRange=="Not employed")
                   &!(IncomeRange=="$0")
                   &!(IncomeRange=="Not displayed")))+
  geom_point(alpha=1/20)+
  facet_wrap(~LoanOriginationQuarter)+
  scale_x_log10(limits=c(500,10000))

# now lets take into account the Loan Original Amount

ggplot(aes(y=BorrowerRate,x=AvailableMonthlyIncome/LoanOriginalAmount),
       data=loanData)+
  geom_point(alpha=1/10)+
  facet_wrap(~LoanOriginationQuarter)+
  scale_x_continuous(limits=c(0.01,10))
  
###employment----
#ggplot(aes(x=employment))
###other borrower stats----
## state, occupation and homeowner...

ggplot(aes(y=BorrowerRate,x=reorder(Occupation, BorrowerRate,FUN=median )),data=loanData)+
  geom_boxplot(aes(color=IsBorrowerHomeowner))+
  coord_flip()

ggplot(aes(y=BorrowerRate,x=reorder(BorrowerState, BorrowerRate,FUN=median )),data=loanData)+
  geom_boxplot(aes(color=IsBorrowerHomeowner))+
  coord_flip()

###----
```

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

### Were there any interesting or surprising interactions between features?
I discovered that the prosper ratings 


### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.



------

# Final Plots and Summary

### Plot One
```{r echo=FALSE, Plot_One}
p1<-ggplot(aes(x=LoanOriginationQuarter,group=1),data=loanData)+
  geom_histogram(binwidth=1)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
p2<-ggplot(aes(x=LoanOriginationQuarter,group=1,y=1/BorrowerRate),data=loanData)+
  geom_line(stat='summary',fun.y=mean)+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
p3<-ggplot(aes(x=LoanOriginationQuarter,group=1,y=LoanOriginalAmount),data=loanData)+
  geom_line(stat='summary',fun.y=mean)+
  coord_cartesian(ylim=c(0,20000))+
  theme(axis.text.x=element_text(angle = 45, hjust = 1))

grid.arrange(p1,p2,p3,ncol=1)

```

### Description One


### Plot Two
```{r echo=FALSE, Plot_Two}

p1<-ggplot(aes(y=BorrowerRate,x=reorder(Occupation, BorrowerRate,FUN=median )),data=loanData)+
  geom_boxplot(aes(color=IsBorrowerHomeowner))+
  coord_flip()

p2<-ggplot(aes(y=BorrowerRate,x=reorder(BorrowerState, BorrowerRate,FUN=median )),data=loanData)+
  geom_boxplot(aes(color=IsBorrowerHomeowner))+
  coord_flip()
grid.arrange(p1,p2)

```

### Description Two


### Plot Three
```{r echo=FALSE, Plot_Three}

ggplot(aes(x=LoanOriginalAmount,y=BorrowerRate),
       data=subset(loanData,
                   LoanPeriod2=="pre-recession"&
                     !(is.na(CreditGrade)|CreditGrade==""|is.na(LoanOriginationQuarter)|LoanOriginationQuarter=="Q2 2009"))   )+
  geom_point(aes(color=CreditGrade),alpha=1)+facet_wrap(~LoanOriginationQuarter)+
  scale_color_brewer("CreditGrade")

```

### Description Three
Up until 2009, the BorrowerRate was relatively well corellated to the credit score, or credit grade and the loan original amount. .....
------

# Reflection
This prosper loan data is a rich dataset that reveals tons of information about the distribution of loans over time. 

